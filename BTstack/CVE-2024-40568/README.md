# Summary
The function `pb_adv_handle_transaction_cont` in **src/mesh/pb_adv.c** does not validate the content before using it. An malicious BLE mesh device can crash BLE mesh provisioner without authentication by sending malformed Generic Provisioning  PDU.

# Description
## Root cause
The code below will be triggered during Provisioning Procedure (using PB-ADV). Assume that we already execute `pb_adv_handle_transaction_start` and `pb_adv_msg_in_last_segment` is assigned the value 7.
- In comment (1), `pdu[0` is controlled by attacker and `pdu` can be assigned the value 6. This will satisfy condition `seg >= MESH_PB_ADV_MAX_SEGMENTS || seg == 0` , so that it won't return.
- In comment (2), since seg is assigned the value 6, `msg_pos` will be 135
- In comment (3), we have to satisfy condition `seg != pb_adv_msg_in_last_segment` to avoid returning.  We have already set `pb_adv_msg_in_last_segment` to 7, so it won't return.
- In comment (4),  provisioner will try to copy segment data to `pb_adv_msg_in_buffer[msg_pos]`,  but `pb_adv_msg_in_buffer` is an fixed size buffer and its size is 100. This will lead to buffer overflow since  the maximum value of `msg_pos` can be set to 135. An attacker can control segment data to overwrite variable after `pb_adv_msg_in_buffer` to achieve code execution.
```c
static void pb_adv_handle_transaction_cont(uint8_t transaction_nr, const uint8_t * pdu, uint16_t size){

	...
	// (1) - pdu[0] is controlled by sender
    uint8_t seg = pdu[0] >> 2;
    if (seg >= MESH_PB_ADV_MAX_SEGMENTS || seg == 0){
        return;
    }

	...

    // (2) - msg_pos can controlled by user 
    uint16_t msg_pos = MESH_PB_ADV_START_PAYLOAD + (seg-1) * MESH_PB_ADV_CONT_PAYLOAD;
    uint16_t fragment_size = size - 1;

    // (3) we should not return here
    if (seg == pb_adv_msg_in_last_segment && (msg_pos + fragment_size) != pb_adv_msg_in_len){
        // last segment has invalid size
        return;
    }

	...
    // (4) size of pb_adv_msg_in_buffer is 100
    // it leads to buffer overflow
(void)memcpy(&pb_adv_msg_in_buffer[msg_pos], &pdu[1], fragment_size);
    pb_adv_msg_in_segments_missing &= ~seg_mask;

     // last segment
     if (pb_adv_msg_in_segments_missing == 0){
        pb_adv_pdu_complete();
    }
}
```

# Affected products
Since it is still in experimental stage, the impact of this vulnerability / bug is therefore low.

# Credits
Reported by Wei Che Kao (Xiaobye), graduate student from National Yang Ming Chiao Tung University, Dept. of CS, Security and Systems Lab.
